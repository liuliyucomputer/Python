# Oracle数据库管理

## 1. 数据库管理概述

### 1.1 数据库管理职责
Oracle数据库管理员(DBA)的主要职责包括：
- 数据库安装和配置
- 数据库监控和性能调优
- 数据库备份和恢复
- 数据库安全管理
- 用户和权限管理
- 数据迁移和转换
- 故障排除和问题解决
- 数据库升级和补丁管理

### 1.2 数据库管理工具
Oracle提供了多种管理工具：
- **SQL*Plus**：命令行管理工具
- **Oracle Enterprise Manager (EM)**：基于Web的图形化管理工具
- **RMAN (Recovery Manager)**：专业备份恢复工具
- **Data Pump**：数据导入导出工具
- **SQL Developer**：开发和管理工具
- **Oracle Configuration Manager**：配置管理工具

## 2. SQL*Plus管理命令

### 2.1 基本管理命令
```sql
-- 连接到数据库
CONNECT username/password@database
CONNECT / AS SYSDBA  -- 以SYSDBA身份连接

-- 显示当前用户
SHOW USER

-- 设置环境变量
SET LINESIZE 100
SET PAGESIZE 50
SET SERVEROUTPUT ON

-- 执行脚本
@script_name.sql
@@script_name.sql  -- 执行嵌套脚本

-- 保存输出
SPOOL output.txt
SELECT * FROM employees;
SPOOL OFF

-- 编辑命令
EDIT
EDIT filename.sql

-- 退出SQL*Plus
EXIT
QUIT
```

### 2.2 数据库启动和关闭
```sql
-- 启动数据库
STARTUP
-- 启动到挂载模式
STARTUP MOUNT
-- 启动到只读模式
STARTUP READ ONLY
-- 强制启动
STARTUP FORCE

-- 关闭数据库
SHUTDOWN
-- 立即关闭
SHUTDOWN IMMEDIATE
-- 事务关闭
SHUTDOWN TRANSACTIONAL
-- 终止关闭
SHUTDOWN ABORT
```

### 2.3 数据库状态管理
```sql
-- 挂载数据库
ALTER DATABASE MOUNT;

-- 打开数据库
ALTER DATABASE OPEN;
-- 打开为只读模式
ALTER DATABASE OPEN READ ONLY;
-- 打开为读写模式
ALTER DATABASE OPEN READ WRITE;

-- 关闭数据库（非SYSDBA用户）
ALTER DATABASE CLOSE;
```

## 3. 表空间管理

### 3.1 表空间概述
表空间是Oracle数据库的逻辑存储单元，用于管理数据文件。常见表空间类型：
- **系统表空间**：存储系统数据字典
- **SYSAUX表空间**：辅助系统表空间
- **临时表空间**：存储临时数据
- **用户表空间**：存储用户数据
- **撤销表空间**：存储撤销数据

### 3.2 表空间操作
```sql
-- 创建表空间
CREATE TABLESPACE users_ts
    DATAFILE 'users01.dbf' SIZE 100M
    AUTOEXTEND ON NEXT 10M
    MAXSIZE 500M
    EXTENT MANAGEMENT LOCAL
    SEGMENT SPACE MANAGEMENT AUTO;

-- 创建临时表空间
CREATE TEMPORARY TABLESPACE temp_ts
    TEMPFILE 'temp01.dbf' SIZE 50M
    AUTOEXTEND ON NEXT 10M
    MAXSIZE 200M
    EXTENT MANAGEMENT LOCAL;

-- 创建撤销表空间
CREATE UNDO TABLESPACE undo_ts
    DATAFILE 'undo01.dbf' SIZE 100M
    AUTOEXTEND ON NEXT 20M
    MAXSIZE UNLIMITED;

-- 修改表空间
ALTER TABLESPACE users_ts ADD DATAFILE 'users02.dbf' SIZE 100M;
ALTER TABLESPACE users_ts AUTOEXTEND ON NEXT 20M MAXSIZE 1000M;
ALTER TABLESPACE users_ts READ ONLY;
ALTER TABLESPACE users_ts READ WRITE;

-- 重命名表空间
ALTER TABLESPACE old_ts RENAME TO new_ts;

-- 删除表空间
DROP TABLESPACE users_ts INCLUDING CONTENTS AND DATAFILES;
```

### 3.3 表空间监控
```sql
-- 查询表空间信息
SELECT tablespace_name, status, contents FROM dba_tablespaces;

-- 查询数据文件信息
SELECT tablespace_name, file_name, bytes/1024/1024 AS size_mb, autoextensible FROM dba_data_files;

-- 查询表空间使用情况
SELECT t.tablespace_name,
       ROUND(SUM(d.bytes)/1024/1024, 2) AS total_mb,
       ROUND(SUM(d.bytes - f.bytes_free)/1024/1024, 2) AS used_mb,
       ROUND(SUM(f.bytes_free)/1024/1024, 2) AS free_mb,
       ROUND((SUM(d.bytes - f.bytes_free)/SUM(d.bytes))*100, 2) AS used_pct
FROM dba_tablespaces t
JOIN dba_data_files d ON t.tablespace_name = d.tablespace_name
JOIN dba_free_space f ON t.tablespace_name = f.tablespace_name
GROUP BY t.tablespace_name;
```

## 4. 用户和权限管理

### 4.1 用户管理
```sql
-- 创建用户
CREATE USER myuser IDENTIFIED BY mypassword
    DEFAULT TABLESPACE users_ts
    TEMPORARY TABLESPACE temp_ts
    QUOTA UNLIMITED ON users_ts
    QUOTA 50M ON other_ts;

-- 修改用户
ALTER USER myuser IDENTIFIED BY newpassword;
ALTER USER myuser DEFAULT TABLESPACE new_ts;
ALTER USER myuser QUOTA 100M ON users_ts;
ALTER USER myuser ACCOUNT LOCK;
ALTER USER myuser ACCOUNT UNLOCK;
ALTER USER myuser PASSWORD EXPIRE;

-- 删除用户
DROP USER myuser;
-- 删除用户及其所有对象
DROP USER myuser CASCADE;
```

### 4.2 角色管理
```sql
-- 创建角色
CREATE ROLE developer_role;

-- 授予权限给角色
GRANT CREATE TABLE, CREATE VIEW, CREATE PROCEDURE TO developer_role;
GRANT SELECT, INSERT, UPDATE, DELETE ON hr.employees TO developer_role;

-- 授予角色给用户
GRANT developer_role TO myuser;

-- 撤销角色
REVOKE developer_role FROM myuser;

-- 删除角色
DROP ROLE developer_role;
```

### 4.3 系统权限管理
```sql
-- 授予系统权限
GRANT CREATE SESSION TO myuser;
GRANT CREATE TABLE TO myuser;
GRANT CREATE VIEW TO myuser;
GRANT CREATE PROCEDURE TO myuser;
GRANT CREATE TRIGGER TO myuser;
GRANT DBA TO myuser;  -- 授予DBA权限

-- 撤销系统权限
REVOKE CREATE TABLE FROM myuser;
REVOKE DBA FROM myuser;
```

### 4.4 对象权限管理
```sql
-- 授予对象权限
GRANT SELECT ON hr.employees TO myuser;
GRANT INSERT, UPDATE, DELETE ON hr.employees TO myuser;
GRANT ALL PRIVILEGES ON hr.departments TO myuser;
GRANT EXECUTE ON hr.get_employee_info TO myuser;

-- 授予权限并允许转授
GRANT SELECT ON hr.employees TO myuser WITH GRANT OPTION;

-- 撤销对象权限
REVOKE SELECT ON hr.employees FROM myuser;
REVOKE ALL PRIVILEGES ON hr.departments FROM myuser;
```

## 5. 备份和恢复

### 5.1 备份概述
Oracle备份类型：
- **物理备份**：复制数据库物理文件
- **逻辑备份**：导出数据库逻辑对象
- **完全备份**：备份整个数据库
- **增量备份**：备份自上次备份以来的更改
- **在线备份**：数据库打开时进行的备份
- **离线备份**：数据库关闭时进行的备份

### 5.2 RMAN备份
```sql
-- 启动RMAN
rman target /

-- 连接到恢复目录（可选）
rman target / catalog rman/rman@rcat

-- 配置RMAN
CONFIGURE RETENTION POLICY TO REDUNDANCY 3;
CONFIGURE BACKUP OPTIMIZATION ON;
CONFIGURE DEFAULT DEVICE TYPE TO DISK;
CONFIGURE CHANNEL DEVICE TYPE DISK FORMAT '/backup/%U';
CONFIGURE CONTROLFILE AUTOBACKUP ON;
CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO '/backup/controlfile_%F';

-- 完全数据库备份
BACKUP DATABASE PLUS ARCHIVELOG;

-- 增量备份
BACKUP INCREMENTAL LEVEL 0 DATABASE;
BACKUP INCREMENTAL LEVEL 1 DATABASE;
BACKUP INCREMENTAL LEVEL 1 CUMULATIVE DATABASE;

-- 表空间备份
BACKUP TABLESPACE users, system;

-- 数据文件备份
BACKUP DATAFILE 1, 2, 3;
BACKUP DATAFILE '/u01/oradata/ORCL/users01.dbf';

-- 控制文件备份
BACKUP CURRENT CONTROLFILE;

-- 归档日志备份
BACKUP ARCHIVELOG ALL DELETE INPUT;
BACKUP ARCHIVELOG FROM TIME 'SYSDATE-7';

-- 备份集信息
LIST BACKUP;
LIST BACKUP SUMMARY;
LIST BACKUP BY FILE;

-- 删除备份
DELETE BACKUP;
DELETE BACKUP OF DATABASE;
DELETE EXPIRED BACKUP;
```

### 5.3 RMAN恢复
```sql
-- 完全数据库恢复
RESTORE DATABASE;
RECOVER DATABASE;

-- 表空间恢复
ALTER TABLESPACE users OFFLINE;
RESTORE TABLESPACE users;
RECOVER TABLESPACE users;
ALTER TABLESPACE users ONLINE;

-- 数据文件恢复
ALTER DATABASE DATAFILE '/u01/oradata/ORCL/users01.dbf' OFFLINE;
RESTORE DATAFILE '/u01/oradata/ORCL/users01.dbf';
RECOVER DATAFILE '/u01/oradata/ORCL/users01.dbf';
ALTER DATABASE DATAFILE '/u01/oradata/ORCL/users01.dbf' ONLINE;

-- 控制文件恢复
STARTUP FORCE NOMOUNT;
RESTORE CONTROLFILE FROM '/backup/controlfile_c-1234567890-20230101-00';
ALTER DATABASE MOUNT;
RESTORE DATABASE;
RECOVER DATABASE USING BACKUP CONTROLFILE UNTIL CANCEL;
ALTER DATABASE OPEN RESETLOGS;

-- 时间点恢复
RESTORE DATABASE UNTIL TIME 'SYSDATE-1';
RECOVER DATABASE UNTIL TIME 'SYSDATE-1';
ALTER DATABASE OPEN RESETLOGS;

-- SCN点恢复
RESTORE DATABASE UNTIL SCN 123456789;
RECOVER DATABASE UNTIL SCN 123456789;
ALTER DATABASE OPEN RESETLOGS;
```

### 5.4 Data Pump导入导出

#### 5.4.1 导出数据
```bash
-- 导出整个数据库
expdp system/password@orcl FULL=Y DIRECTORY=dpump_dir DUMPFILE=full_backup.dmp LOGFILE=exp_full.log

-- 导出特定用户
expdp system/password@orcl SCHEMAS=hr,scott DIRECTORY=dpump_dir DUMPFILE=schemas.dmp LOGFILE=exp_schemas.log

-- 导出特定表
expdp hr/password@orcl TABLES=employees,departments DIRECTORY=dpump_dir DUMPFILE=tables.dmp LOGFILE=exp_tables.log

-- 导出表空间
expdp system/password@orcl TABLESPACES=users,system DIRECTORY=dpump_dir DUMPFILE=tablespaces.dmp LOGFILE=exp_tablespaces.log

-- 增量导出
expdp system/password@orcl FULL=Y DIRECTORY=dpump_dir DUMPFILE=incremental.dmp LOGFILE=exp_incr.log FLASHBACK_TIME=SYSTIMESTAMP
```

#### 5.4.2 导入数据
```bash
-- 导入整个数据库
impdp system/password@orcl FULL=Y DIRECTORY=dpump_dir DUMPFILE=full_backup.dmp LOGFILE=imp_full.log

-- 导入特定用户
impdp system/password@orcl SCHEMAS=hr,scott DIRECTORY=dpump_dir DUMPFILE=schemas.dmp LOGFILE=imp_schemas.log

-- 导入特定表
impdp hr/password@orcl TABLES=employees,departments DIRECTORY=dpump_dir DUMPFILE=tables.dmp LOGFILE=imp_tables.log

-- 导入表空间
impdp system/password@orcl TABLESPACES=users DIRECTORY=dpump_dir DUMPFILE=tablespaces.dmp LOGFILE=imp_tablespaces.log

-- 表空间重映射
impdp hr/password@orcl TABLES=employees DIRECTORY=dpump_dir DUMPFILE=tables.dmp LOGFILE=imp_remap.log REMAP_TABLESPACE=users:new_users

-- 用户重映射
impdp system/password@orcl SCHEMAS=hr DIRECTORY=dpump_dir DUMPFILE=schemas.dmp LOGFILE=imp_remap.log REMAP_SCHEMA=hr:hr_new

-- 表重映射
impdp hr/password@orcl TABLES=employees DIRECTORY=dpump_dir DUMPFILE=tables.dmp LOGFILE=imp_remap.log REMAP_TABLE=employees:emp_backup
```

### 5.5 传统导出导入（exp/imp）
```bash
-- 导出整个数据库
exp system/password@orcl FULL=Y FILE=full_backup.dmp LOG=exp_full.log

-- 导出特定用户
exp system/password@orcl OWNER=hr,scott FILE=schemas.dmp LOG=exp_schemas.log

-- 导出特定表
exp hr/password@orcl TABLES=employees,departments FILE=tables.dmp LOG=exp_tables.log

-- 导入整个数据库
imp system/password@orcl FULL=Y FILE=full_backup.dmp LOG=imp_full.log

-- 导入特定用户
imp system/password@orcl FROMUSER=hr TOUSER=hr_new FILE=schemas.dmp LOG=imp_schemas.log

-- 导入特定表
imp hr/password@orcl TABLES=employees,departments FILE=tables.dmp LOG=imp_tables.log
```

## 6. 性能监控和调优

### 6.1 性能监控工具
- **AWR (Automatic Workload Repository)**：自动工作负载仓库
- **ASH (Active Session History)**：活动会话历史
- **ADDM (Automatic Database Diagnostic Monitor)**：自动数据库诊断监视器
- **SQL Tuning Advisor**：SQL调优顾问
- **SQL Access Advisor**：SQL访问顾问

### 6.2 性能监控视图
```sql
-- 数据库等待事件
SELECT event, count(*) FROM v$session_wait GROUP BY event ORDER BY count(*) DESC;

-- 长时间运行的SQL
SELECT sql_id, elapsed_time, cpu_time, disk_reads, buffer_gets, sql_text
FROM v$sqlarea
WHERE elapsed_time > 10000000  -- 10秒
ORDER BY elapsed_time DESC;

-- 会话信息
SELECT sid, serial#, username, status, program, sql_id, event
FROM v$session
WHERE status = 'ACTIVE';

-- 表空间使用情况
SELECT tablespace_name, used_percent FROM dba_tablespace_usage_metrics;

-- 数据文件I/O
SELECT file_name, phyrds, phyblkrd, phywrts, phyblkwrt
FROM v$filestat f, dba_data_files d
WHERE f.file# = d.file_id;

-- 内存使用情况
SELECT * FROM v$sga;
SELECT * FROM v$pga_target_advice;
```

### 6.3 AWR报告
```sql
-- 生成AWR报告
@$ORACLE_HOME/rdbms/admin/awrrpt.sql
-- 生成AWR对比报告
@$ORACLE_HOME/rdbms/admin/awrddrpt.sql
```

### 6.4 SQL调优
```sql
-- 查看SQL执行计划
EXPLAIN PLAN FOR SELECT * FROM employees WHERE department_id = 50;
SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY);

-- 使用AUTOTRACE
SET AUTOTRACE ON
SELECT * FROM employees WHERE department_id = 50;

-- 收集统计信息
EXEC DBMS_STATS.GATHER_TABLE_STATS('HR', 'EMPLOYEES');
EXEC DBMS_STATS.GATHER_SCHEMA_STATS('HR');
EXEC DBMS_STATS.GATHER_DATABASE_STATS();

-- SQL Tuning Advisor
DECLARE
  l_sql_id VARCHAR2(13) := 'SQL_ID值';
  l_task_id VARCHAR2(30);
BEGIN
  l_task_id := DBMS_SQLTUNE.CREATE_TUNING_TASK(sql_id => l_sql_id);
  DBMS_SQLTUNE.EXECUTE_TUNING_TASK(task_id => l_task_id);
  DBMS_OUTPUT.PUT_LINE('Task ID: ' || l_task_id);
END;
/

SELECT DBMS_SQLTUNE.REPORT_TUNING_TASK('Task ID值') FROM dual;
```

## 7. 日志管理

### 7.1 重做日志管理
```sql
-- 查看重做日志组和成员
SELECT group#, member FROM v$logfile;
SELECT group#, status, bytes/1024/1024 AS size_mb FROM v$log;

-- 添加重做日志组
ALTER DATABASE ADD LOGFILE GROUP 4 ('/u01/oradata/ORCL/redo04a.log', '/u01/oradata/ORCL/redo04b.log') SIZE 100M;

-- 添加重做日志成员
ALTER DATABASE ADD LOGFILE MEMBER '/u01/oradata/ORCL/redo01b.log' TO GROUP 1;

-- 切换重做日志
ALTER SYSTEM SWITCH LOGFILE;

-- 清除重做日志
ALTER DATABASE CLEAR LOGFILE GROUP 1;
ALTER DATABASE CLEAR UNARCHIVED LOGFILE GROUP 1;  -- 清除未归档的日志

-- 删除重做日志组
ALTER DATABASE DROP LOGFILE GROUP 4;

-- 删除重做日志成员
ALTER DATABASE DROP LOGFILE MEMBER '/u01/oradata/ORCL/redo01b.log';
```

### 7.2 归档日志管理
```sql
-- 查看归档模式
SELECT log_mode FROM v$database;

-- 启用归档模式
SHUTDOWN IMMEDIATE
STARTUP MOUNT
ALTER DATABASE ARCHIVELOG;
ALTER DATABASE OPEN;

-- 禁用归档模式
SHUTDOWN IMMEDIATE
STARTUP MOUNT
ALTER DATABASE NOARCHIVELOG;
ALTER DATABASE OPEN;

-- 配置归档日志位置
ALTER SYSTEM SET log_archive_dest_1 = 'LOCATION=/u01/archive';
ALTER SYSTEM SET log_archive_format = 'arch_%t_%s_%r.arc' SCOPE=SPFILE;

-- 手动归档
ALTER SYSTEM ARCHIVE LOG CURRENT;
ALTER SYSTEM ARCHIVE LOG ALL;

-- 查看归档日志信息
SELECT name, sequence#, first_time, next_time FROM v$archived_log;
```

## 8. 数据迁移

### 8.1 数据迁移方法
- **数据泵导入导出**：适合同版本或跨版本迁移
- **RMAN备份恢复**：适合同平台迁移
- **GoldenGate**：适合同步迁移
- **SQL*Loader**：适合从文本文件加载数据
- **外部表**：适合从外部数据源访问数据

### 8.2 SQL*Loader
```sql
-- 控制文件示例 (load_data.ctl)
LOAD DATA
INFILE 'employees.csv'
BADFILE 'employees.bad'
DISCARDFILE 'employees.dsc'
APPEND
INTO TABLE employees
FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
TRAILING NULLCOLS
(
  employee_id,
  first_name,
  last_name,
  email,
  phone_number,
  hire_date DATE 'YYYY-MM-DD',
  job_id,
  salary,
  commission_pct,
  manager_id,
  department_id
)

-- 执行SQL*Loader
sqlldr userid=hr/password@orcl control=load_data.ctl log=load_data.log
```

### 8.3 外部表
```sql
-- 创建外部表目录
CREATE DIRECTORY ext_tab_dir AS '/u01/external_data';

-- 创建外部表
CREATE TABLE ext_employees (
  employee_id NUMBER(6),
  first_name VARCHAR2(20),
  last_name VARCHAR2(25),
  email VARCHAR2(25),
  hire_date DATE
) ORGANIZATION EXTERNAL (
  TYPE ORACLE_LOADER
  DEFAULT DIRECTORY ext_tab_dir
  ACCESS PARAMETERS (
    RECORDS DELIMITED BY NEWLINE
    FIELDS TERMINATED BY ','
    MISSING FIELD VALUES ARE NULL
    (
      employee_id,
      first_name,
      last_name,
      email,
      hire_date DATE 'YYYY-MM-DD'
    )
  )
  LOCATION ('employees.csv')
);

-- 查询外部表
SELECT * FROM ext_employees;

-- 将外部表数据加载到内部表
INSERT INTO employees (employee_id, first_name, last_name, email, hire_date)
SELECT employee_id, first_name, last_name, email, hire_date FROM ext_employees;
```

## 9. 故障排除

### 9.1 常见故障类型
- **数据库启动失败**
- **用户连接问题**
- **性能下降**
- **数据损坏**
- **磁盘空间不足**
- **网络问题**
- **权限问题**

### 9.2 日志文件查看
```sql
-- 查看告警日志
SHOW PARAMETER background_dump_dest;
-- 告警日志文件通常位于: $ORACLE_BASE/diag/rdbms/orcl/ORCL/trace/alert_ORCL.log

-- 查看监听器日志
lsnrctl status  -- 查看监听器日志位置

-- 查看会话跟踪文件
SELECT sid, serial#, tracefile FROM v$session WHERE username = 'HR';
```

### 9.3 常见问题解决

#### 9.3.1 数据库无法启动
```sql
-- 检查告警日志
-- 检查参数文件
STARTUP NOMOUNT PFILE='/path/to/init.ora'
-- 检查控制文件
ALTER DATABASE MOUNT;
-- 检查数据文件
SELECT name, status FROM v$datafile;
```

#### 9.3.2 用户无法连接
```sql
-- 检查监听器状态
lsnrctl status
-- 启动监听器
lsnrctl start
-- 检查服务注册
ALTER SYSTEM REGISTER;
-- 检查用户状态
SELECT username, account_status FROM dba_users WHERE username = 'HR';
-- 解锁用户
ALTER USER hr ACCOUNT UNLOCK;
-- 重置密码
ALTER USER hr IDENTIFIED BY new_password;
```

#### 9.3.3 磁盘空间不足
```sql
-- 检查表空间使用情况
SELECT tablespace_name, used_percent FROM dba_tablespace_usage_metrics;
-- 添加数据文件
ALTER TABLESPACE users ADD DATAFILE '/u01/oradata/ORCL/users02.dbf' SIZE 100M;
-- 扩展数据文件
ALTER DATABASE DATAFILE '/u01/oradata/ORCL/users01.dbf' RESIZE 200M;
-- 清理归档日志
DELETE ARCHIVELOG ALL COMPLETED BEFORE 'SYSDATE-7';
```

## 10. 总结

Oracle数据库管理是一项复杂但重要的工作，需要掌握多种工具和技术。本章节介绍了Oracle数据库管理的核心内容，包括：

- 数据库启动和关闭
- 表空间管理
- 用户和权限管理
- 备份和恢复
- 性能监控和调优
- 日志管理
- 数据迁移
- 故障排除

通过不断学习和实践这些管理技能，您将能够有效地管理Oracle数据库，确保数据库的安全性、可用性和性能，成为一名优秀的数据库管理员。

下一章：[Oracle数据库高级特性](05_高级特性.md)